general:
    artifacts:
        - ./server/coverage_report.txt
        - ./client/coverage/text/*
        - ./server.tar.gz
        - ./client.tar.gz

machine:
    python:
        version: 2.7.6
    node:
        version: v0.10.22


dependencies:
    override:
        - pip install -r server/requirements.txt
        - pip install -r server/requirements_dev.txt
        - 'npm prune && npm install':
            pwd:
                client
        - bower install:
            pwd:
                client
    cache_directories:
        - "client/node_modules"

checkout:
    post:
        - cp ./server/server/localsettings.py.circle-ci ./server/server/localsettings.py
        - cp ./client/test/protractor.localconf.json.circle-ci ./client/test/protractor.localconf.json

test:
    override:
        - 'python manage.py collectstatic --noinput':
            pwd: server
        - 'case $CIRCLE_NODE_INDEX in 0) cd server && coverage run manage.py test  ;; 1) cd client && grunt test && cd .. && ./run_e2e.sh ;; esac':
            parallel: true
    post:
        - 'mkdir client/dist && git rev-parse HEAD | tee server/git_commit_hash.txt client/dist/git_commit_hash.txt'
        - 'if [[ "$CIRCLE_NODE_INDEX" = "0" ]]; then  tar -pc * -zf ../server.tar.gz; fi':
            pwd: server
        - 'if [[ "$CIRCLE_NODE_INDEX" = "1" ]]; then  tar -pc dist/ ../server/static -zf ../client.tar.gz; fi':
            pwd: client
        - coverage report > coverage_report.txt:
            pwd: server
        - coverage xml:
            pwd: server
        - test "$CIRCLE_BRANCH" == "master" && pushci --debug || exit 0
