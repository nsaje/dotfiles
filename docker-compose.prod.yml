eins:
    image: z1-bundle:current
    restart: always
    hostname: ${HOSTNAME}
    external_links:
      - memcached
    ports:
      - "8000"
    volumes:
      - "/mnt/logs/eins:/app/logs"
    mem_limit: 256m
    labels:
      - "traefik.backend=einsapi"
      - "traefik.frontend.value=one.zemanta.com"
      - "traefik.frontend.rule=Host"
      - "traefik.frontend.passHostHeader=true"
    log_driver: json-file
    log_opt:
      max-size: "50m"
      max-file: "3"
      labels: "eins"
    environment:
      - "CONF_ENV=prod"
      - "VIRTUAL_HOST=one.zemanta.com"
      - "NEW_RELIC_LICENSE_KEY=1dfbd7b07a5cbf7bcc6eb18db5003808a058d16f"
      - "NEW_RELIC_APP_NAME=Zemanta One"
      - "NEW_RELIC_PROCESS_HOST_DISPLAY_NAME=${HOSTNAME}-docker"
      - "GUNICORN_TO=30"
      - "GUNICORN_WORKERS=16"
    command: /start-server.sh
    mem_limit: 3g

eins-api-callback:
    extends: eins
    environment:
      - "VIRTUAL_HOST=one-cb.zemanta.com"
      - "NEW_RELIC_LICENSE_KEY=1dfbd7b07a5cbf7bcc6eb18db5003808a058d16f"
      - "NEW_RELIC_APP_NAME=Zemanta One (callback API)"
      - "NEW_RELIC_PROCESS_HOST_DISPLAY_NAME=${HOSTNAME}-docker"
      - "GUNICORN_WORKERS=4"
    command: /start-server.sh
    mem_limit: 1g
    #   default cpu.cfs_period_us is 100000. That is 100% of one CPU core
    cpu_quota: 200000
    labels:
      - "traefik.backend=einsapicallback"
      - "traefik.frontend.value=one-cb.zemanta.com"
      - "traefik.frontend.rule=Host"
      - "traefik.frontend.passHostHeader=true"


api_ambassador:
    image: verb/socat
    restart: always
    command: TCP-LISTEN:8000,fork TCP:upstream:8000
    links:
      - eins:upstream
    ports:
      - "8001:8000"
    mem_limit: 128m


einsworker_convapi:
    extends: eins
    mem_limit: 256m
    environment:
      - "C_FORCE_ROOT=true"
    labels:
      - "traefik.enable=false"
    entrypoint: ""
    command: "celery worker -A server -c 3 -Q prod-convapi -l INFO -f /app/logs/eins_celery_convapi.log"


einsworker_convapi_v2:
    extends: eins
    mem_limit: 256m
    environment:
      - "C_FORCE_ROOT=true"
    labels:
      - "traefik.enable=false"
    entrypoint: ""
    command: "celery worker -A server -c 3 -Q prod-convapi_v2 -l INFO -f /app/logs/eins_celery_convapi_v2.log"
