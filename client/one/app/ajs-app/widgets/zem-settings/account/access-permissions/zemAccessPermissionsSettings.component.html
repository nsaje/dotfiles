<div
    class="zem-settings-component__container table-access-permissions"
    ng-if="$ctrl.hasPermission('zemauth.account_agency_access_permissions') && $ctrl.agencyManagers !== null && $ctrl.agencyManagers !== undefined && !$ctrl.hasPermission('zemauth.can_see_agency_managers_under_access_permissions')"
>
    <div class="zem-settings-component__header">Agency managers</div>
    <div class="form-group">
        <label for="first-name-input" class="col-xs-2 control-label">
            <zem-internal-feature
                ng-if="$ctrl.isPermissionInternal('zemauth.account_agency_access_permissions')"
                popover-placement="bottom"
            ></zem-internal-feature>
            Agency Managers
            <zem-help-popover
                content="Users who are members of account's agency and have access to the account you're currently on."
                placement="top"
            ></zem-help-popover>
        </label>
        <div class="col-xs-8">
            <div
                ng-if="$ctrl.agencyManagers.length === 0"
                class="form-group existing-user-row"
            >
                <div class="col-xs-8 user-name-col">
                    <p class="control-label">Not defined</p>
                </div>
            </div>

            <div
                ng-repeat="user in $ctrl.agencyManagers"
                class="form-group existing-user-row"
            >
                <div class="col-xs-8 user-name-col">
                    <p class="control-label">
                        <b>{{ user.name }} </b>({{ user.email }})
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
<div
    class="zem-settings-component__container table-access-permissions"
    ng-if="$ctrl.hasPermission('zemauth.account_agency_access_permissions')"
>
    <zem-internal-feature
        ng-if="$ctrl.isPermissionInternal('zemauth.account_agency_access_permissions')"
        popover-placement="bottom"
    ></zem-internal-feature>
    <div class="zem-settings-component__header">Users</div>
    <div class="zem-settings-component__description">
        Users who have access to the account you're currently on.
    </div>
    <div class="table-container">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Name and Last name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th></th>
                </tr>
            </thead>
            <tbody ng-repeat="user in $ctrl.users">
                <tr ng-if="user.removed">
                    <td colspan="4">
                        The user was removed.
                        <a
                            ng-show="!user.requestInProgress"
                            ng-click="$ctrl.undoRemove(user.id)"
                            >Undo?</a
                        >
                        <div
                            class="loader"
                            ng-show="user.requestInProgress"
                        ></div>
                    </td>
                </tr>
                <tr ng-if="!user.removed">
                    <td>
                        <strong>{{ user.name }}</strong>
                        <span
                            ng-show="user.saved && !user.emailSent && !user.emailResent"
                            class="success"
                            >This user can now access this account. Since this
                            is an existing user, no activation email was
                            sent.</span
                        >
                        <span
                            ng-show="user.saved && user.emailSent && !user.emailResent"
                            class="success"
                            >An introductory email was sent to this user.</span
                        >
                        <span
                            ng-show="user.saved && user.emailResent"
                            class="success"
                            >New activation email sent.</span
                        >
                    </td>
                    <td>{{ user.email }}</td>
                    <td>
                        <span ng-if="user.is_agency_manager"
                            >Agency Manager</span
                        ><span ng-if="!user.is_agency_manager"
                            >Normal user</span
                        >
                    </td>
                    <td class="action-buttons">
                        <div
                            class="loader"
                            ng-show="user.requestInProgress"
                        ></div>
                        <div ng-show="!user.requestInProgress">
                            <span
                                ng-if="$ctrl.entity.settings.agency && !user.is_agency_manager && $ctrl.hasPermission('zemauth.can_promote_agency_managers')"
                            >
                                <zem-internal-feature
                                    ng-if="$ctrl.isPermissionInternal('zemauth.can_promote_agency_managers')"
                                    popover-placement="bottom"
                                ></zem-internal-feature>
                                <button
                                    tabindex="-1"
                                    ng-click="$ctrl.promoteUser(user)"
                                    href="#"
                                    class="button button--small"
                                    title="Promote to Agency Manager"
                                >
                                    Promote
                                </button>
                            </span>
                            <span
                                ng-if="$ctrl.entity.settings.agency && user.is_agency_manager && $ctrl.hasPermission('zemauth.can_promote_agency_managers')"
                            >
                                <zem-internal-feature
                                    ng-if="$ctrl.isPermissionInternal('zemauth.can_promote_agency_managers')"
                                    popover-placement="bottom"
                                ></zem-internal-feature>
                                <button
                                    tabindex="-1"
                                    ng-click="$ctrl.downgradeUser(user)"
                                    href="#"
                                    class="button button--small"
                                    title="Downgrade to Normal User"
                                >
                                    Downgrade
                                </button>
                            </span>
                            <button
                                ng-show="!user.is_active"
                                tabindex="-1"
                                ng-click="$ctrl.userActionChange('resend', user.id)"
                                href="#"
                                class="button button--small button--with-icon send-icon"
                                title="Resend Activation Mail"
                            >
                                Resend
                            </button>
                            <button
                                tabindex="-1"
                                ng-click="$ctrl.userActionChange('remove', user.id)"
                                href="#"
                                class="button button--small button--with-icon remove-icon"
                            >
                                Remove
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr id="add-user-row" class="add_new">
                    <td colspan="4">
                        <h3>Add new user</h3>
                        <div class="form">
                            <div
                                class="form__group"
                                ng-class="{'form--error': !!$ctrl.addUserErrors.errors.firstName}"
                            >
                                <label
                                    class="form__label"
                                    for="first-name-input"
                                    >Name:</label
                                >
                                <input
                                    class="input-text"
                                    id="first-name-input"
                                    type="text"
                                    placeholder="Name"
                                    ng-model="$ctrl.addUserData.firstName"
                                />
                            </div>
                            <div
                                class="form__group"
                                ng-class="{'form--error': !!$ctrl.addUserErrors.errors.lastName}"
                            >
                                <label class="form__label" for="last-name-input"
                                    >Last name:</label
                                >
                                <input
                                    class="input-text"
                                    id="last-name-input"
                                    type="text"
                                    placeholder="Last name"
                                    ng-model="$ctrl.addUserData.lastName"
                                />
                            </div>
                            <div
                                class="form__group"
                                ng-class="{'form--error': !!$ctrl.addUserErrors.errors.email}"
                            >
                                <label class="form__label" for="email-input"
                                    >Email:</label
                                >
                                <input
                                    class="input-text"
                                    id="email-input"
                                    type="text"
                                    placeholder="Email"
                                    ng-model="$ctrl.addUserData.email"
                                />
                            </div>
                            <div class="form__indented-group buttons-panel">
                                <button
                                    type="button"
                                    class="button button--with-icon add-icon"
                                    ng-click="$ctrl.addUser()"
                                >
                                    Add new user
                                </button>
                                <div
                                    class="loader"
                                    ng-show="$ctrl.addUserRequestInProgress"
                                ></div>
                                <div
                                    class="message message--error"
                                    ng-show="$ctrl.addUserErrors"
                                >
                                    <span class="error">{{
                                        $ctrl.addUserErrors.message
                                    }}</span>
                                    <span
                                        ng-show="$ctrl.addUserErrors.conflict"
                                    ></span>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
