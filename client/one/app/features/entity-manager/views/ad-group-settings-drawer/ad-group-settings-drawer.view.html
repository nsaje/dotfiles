<zem-drawer
    class="zem-drawer"
    [isOpen]="isOpen"
    [isClosable]="!isNewEntity"
    (closeRequest)="cancel()"
>
    <ng-container *ngIf="(store.state$ | async) as state">
        <div class="zem-drawer__header zem-settings__settings-header">
            {{ state.entity.name }}
        </div>
        <div
            class="zem-drawer__content custom-scroller zem-settings__settings-container"
        >
            <div class="zem-panel zem-settings__panel">
                <h2 class="zem-panel__title">Scheduling</h2>
                <div class="zem-settings-section">
                    <zem-date-setting
                        class="zem-settings-section__item"
                        label="Start date"
                        helpMessage="The start date of the ad group. If the date is set in the future, the ad group will not run until that date."
                        [value]="state.entity.startDate"
                        [isDisabled]="state.extras.isCampaignAutopilotEnabled"
                        [errors]="state.fieldsErrors.startDate"
                        (valueChange)="store.updateSetting('startDate', $event)"
                    ></zem-date-setting>
                    <zem-date-setting
                        class="zem-settings-section__item"
                        label="End date"
                        helpMessage="The end date of the ad group. Ad group will run until the end of stop date."
                        [value]="state.entity.endDate"
                        [isDisabled]="state.extras.isCampaignAutopilotEnabled"
                        [minDate]="minEndDate"
                        [allowManualOverride]="true"
                        [errors]="state.fieldsErrors.endDate"
                        (valueChange)="store.updateSetting('endDate', $event)"
                    ></zem-date-setting>
                    <div
                        class="zem-settings-section__item zem-settings-section__item--indented"
                        *ngIf="state.extras.isCampaignAutopilotEnabled"
                    >
                        <div
                            class="zem-message zem-message--bubble zem-message--warning zem-message--with-icon zem-warning-bg-icon"
                        >
                            Flight time settings are disabled because campaign
                            budget optimization is enabled. Budget flight time
                            is used for running the ad group.
                        </div>
                    </div>
                    <zem-delivery-type-setting
                        class="zem-delivery-type-setting zem-settings-section__item"
                        *ngIf="
                            zemPermissions.hasPermission(
                                'zemauth.can_set_delivery_type'
                            )
                        "
                        [zemInternalFeature]="
                            zemPermissions.isPermissionInternal(
                                'zemauth.can_set_delivery_type'
                            )
                        "
                        [deliveryType]="state.entity.deliveryType"
                        [errors]="state.fieldsErrors.deliveryType"
                        (valueChange)="
                            store.updateSetting('deliveryType', $event)
                        "
                    ></zem-delivery-type-setting>
                </div>
                <div
                    class="zem-settings-section"
                    *ngIf="
                        zemPermissions.hasPermission(
                            'zemauth.can_manage_ad_group_dayparting'
                        )
                    "
                >
                    <div class="zem-settings-section__header">
                        <div
                            class="zem-settings-section__title"
                            [zemInternalFeature]="
                                zemPermissions.isPermissionInternal(
                                    'zemauth.can_manage_ad_group_dayparting'
                                )
                            "
                        >
                            Dayparting
                        </div>
                        <div class="zem-settings-section__description">
                            You can schedule your ads to be active for specific
                            hours and days of the week. Ads will be shown in the
                            viewerâ€™s local time.
                        </div>
                    </div>
                    <zem-dayparting-setting
                        class="zem-dayparting-setting"
                        [daypartingSetting]="state.entity.dayparting"
                        [errors]="state.fieldsErrors.dayparting"
                        (valueChange)="
                            store.updateSetting('dayparting', $event)
                        "
                    ></zem-dayparting-setting>
                </div>
            </div>

            <div class="zem-panel zem-settings__panel">
                <h2 class="zem-panel__title">Budgeting and daily limits</h2>
                <div class="zem-settings-section">
                    <zem-bidding-type-setting
                        class="zem-bidding-type-setting zem-settings-section__item"
                        *ngIf="
                            zemPermissions.hasPermission(
                                'zemauth.fea_can_use_cpm_buying'
                            )
                        "
                        [zemInternalFeature]="
                            zemPermissions.isPermissionInternal(
                                'zemauth.fea_can_use_cpm_buying'
                            )
                        "
                        [biddingType]="state.entity.biddingType"
                        [maxCpc]="state.entity.maxCpc"
                        [maxCpm]="state.entity.maxCpm"
                        [currencySymbol]="currencySymbol"
                        [biddingTypeErrors]="state.fieldsErrors.biddingType"
                        [maxCpcErrors]="state.fieldsErrors.maxCpc"
                        [maxCpmErrors]="state.fieldsErrors.maxCpm"
                        (biddingTypeChange)="
                            store.updateSetting('biddingType', $event)
                        "
                        (maxCpcChange)="store.updateSetting('maxCpc', $event)"
                        (maxCpmChange)="store.updateSetting('maxCpm', $event)"
                    ></zem-bidding-type-setting>
                    <!-- PRTODO (jurebajt): Extract into component -->
                    <div class="zem-settings-section__item">
                        <div class="zem-settings-form-group">
                            <label
                                class="zem-settings-form-group__label zem-settings-form-group__label--match-input-height"
                            >
                                Ad group's daily spend cap
                                <zem-help-popover
                                    class="zem-help-popover"
                                    content="Amount of budget autopilot can operate with on this ad group every day."
                                    placement="bottom"
                                ></zem-help-popover>
                            </label>
                            <div class="zem-settings-form-group__content">
                                <div
                                    class="zem-settings-form-group__content-item"
                                >
                                    <zem-currency-input
                                        class="zem-currency-input"
                                        [value]="
                                            state.entity.autopilot.dailyBudget
                                        "
                                        [hasError]="
                                            state.fieldsErrors.autopilot
                                                .dailyBudget &&
                                            state.fieldsErrors.autopilot
                                                .dailyBudget.length > 0
                                        "
                                        [isDisabled]="
                                            !store.isAdGroupAutopilotEnabled()
                                        "
                                        [currencySymbol]="currencySymbol"
                                        fractionSize="0"
                                        (inputBlur)="
                                            store.updateAutopilotDailyBudget(
                                                $event
                                            )
                                        "
                                    ></zem-currency-input>
                                </div>
                                <div
                                    class="zem-settings-form-group__content-item zem-message zem-message--error"
                                    *ngFor="
                                        let error of state.fieldsErrors
                                            .autopilot.dailyBudget
                                    "
                                >
                                    {{ error }}
                                </div>
                                <div
                                    class="zem-settings-form-group__content-item zem-message zem-message--bubble zem-message--warning zem-message--with-icon zem-warning-bg-icon"
                                    *ngIf="!store.isAdGroupAutopilotEnabled()"
                                >
                                    <ng-container
                                        *ngIf="
                                            state.extras
                                                .isCampaignAutopilotEnabled
                                        "
                                    >
                                        Ad group's daily spend cap setting is
                                        disabled because autopilot is managed on
                                        campaign level.
                                    </ng-container>
                                    <ng-container
                                        *ngIf="
                                            !state.extras
                                                .isCampaignAutopilotEnabled
                                        "
                                    >
                                        Ad group's daily spend cap setting is
                                        disabled because autopilot is not
                                        enabled on this ad group.
                                    </ng-container>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="zem-drawer__footer zem-settings__settings-footer">
            <button (click)="saveSettings()">
                <ng-container *ngIf="isNewEntity">Create</ng-container>
                <ng-container *ngIf="!isNewEntity">Save</ng-container>
            </button>
            <button (click)="cancel()">Cancel</button>
            <button *ngIf="!isNewEntity" (click)="archive()">Archive</button>
        </div>
    </ng-container>
</zem-drawer>
