<zem-drawer
    class="zem-drawer"
    [isOpen]="isOpen"
    [isClosable]="!isNewEntity"
    (closeRequest)="cancel()"
>
    <ng-container *ngIf="(store.state$ | async) as state">
        <div class="zem-drawer__header zem-settings__settings-header">
            {{ state.entity.name }}
        </div>
        <div
            class="zem-drawer__content custom-scroller zem-settings__settings-container"
        >
            <div class="zem-panel zem-settings__panel">
                <div class="zem-panel__header">
                    <h2 class="zem-settings__panel-header-title">Scheduling</h2>
                </div>
                <div class="zem-settings-section">
                    <zem-date-setting
                        class="zem-date-setting zem-settings-section__item"
                        label="Start date"
                        helpMessage="The start date of the ad group. If the date is set in the future, the ad group will not run until that date."
                        [value]="state.entity.startDate"
                        [isDisabled]="state.extras.isCampaignAutopilotEnabled"
                        [errors]="state.fieldsErrors.startDate"
                        (valueChange)="store.setStartDate($event)"
                    ></zem-date-setting>
                    <zem-date-setting
                        class="zem-date-setting zem-settings-section__item"
                        label="End date"
                        helpMessage="The end date of the ad group. Ad group will run until the end of stop date."
                        [value]="state.entity.endDate"
                        [isDisabled]="state.extras.isCampaignAutopilotEnabled"
                        [minDate]="minEndDate"
                        [allowManualOverride]="true"
                        [errors]="state.fieldsErrors.endDate"
                        (valueChange)="store.setEndDate($event)"
                    ></zem-date-setting>
                    <div
                        class="zem-settings-section__item zem-settings-section__item--indented"
                        *ngIf="state.extras.isCampaignAutopilotEnabled"
                    >
                        <div
                            class="zem-message zem-message--bubble zem-message--warning zem-message--with-icon zem-warning-bg-icon"
                        >
                            Flight time settings are disabled because campaign
                            budget optimization is enabled. Budget flight time
                            is used for running the ad group.
                        </div>
                    </div>
                    <zem-delivery-type-setting
                        class="zem-delivery-type-setting zem-settings-section__item"
                        *ngIf="
                            zemPermissions.hasPermission(
                                'zemauth.can_set_delivery_type'
                            )
                        "
                        [zemInternalFeature]="
                            zemPermissions.isPermissionInternal(
                                'zemauth.can_set_delivery_type'
                            )
                        "
                        [deliveryType]="state.entity.deliveryType"
                        [errors]="state.fieldsErrors.deliveryType"
                        (valueChange)="store.setDeliveryType($event)"
                    ></zem-delivery-type-setting>
                </div>
                <div
                    class="zem-settings-section"
                    *ngIf="
                        zemPermissions.hasPermission(
                            'zemauth.can_manage_ad_group_dayparting'
                        )
                    "
                >
                    <div class="zem-settings-section__header">
                        <div
                            class="zem-settings-section__title"
                            [zemInternalFeature]="
                                zemPermissions.isPermissionInternal(
                                    'zemauth.can_manage_ad_group_dayparting'
                                )
                            "
                        >
                            Dayparting
                        </div>
                        <div class="zem-settings-section__description">
                            You can schedule your ads to be active for specific
                            hours and days of the week. Ads will be shown in the
                            viewerâ€™s local time.
                        </div>
                    </div>
                    <zem-dayparting-setting
                        class="zem-dayparting-setting"
                        [daypartingSetting]="state.entity.dayparting"
                        [errors]="state.fieldsErrors.dayparting"
                        (valueChange)="store.setDayparting($event)"
                    ></zem-dayparting-setting>
                </div>
            </div>

            <div class="zem-panel zem-settings__panel">
                <div class="zem-panel__header">
                    <h2 class="zem-settings__panel-header-title">
                        Budgeting and daily limits
                    </h2>
                </div>
                <div class="zem-settings-section">
                    <zem-bidding-type-setting
                        class="zem-bidding-type-setting zem-settings-section__item"
                        *ngIf="
                            zemPermissions.hasPermission(
                                'zemauth.fea_can_use_cpm_buying'
                            )
                        "
                        [zemInternalFeature]="
                            zemPermissions.isPermissionInternal(
                                'zemauth.fea_can_use_cpm_buying'
                            )
                        "
                        [biddingType]="state.entity.biddingType"
                        [maxCpc]="state.entity.maxCpc"
                        [maxCpm]="state.entity.maxCpm"
                        [currencySymbol]="currencySymbol"
                        [biddingTypeErrors]="state.fieldsErrors.biddingType"
                        [maxCpcErrors]="state.fieldsErrors.maxCpc"
                        [maxCpmErrors]="state.fieldsErrors.maxCpm"
                        (biddingTypeChange)="store.setBiddingType($event)"
                        (maxCpcChange)="store.setMaxCpc($event)"
                        (maxCpmChange)="store.setMaxCpm($event)"
                    ></zem-bidding-type-setting>
                    <zem-currency-setting
                        class="zem-currency-setting zem-settings-section__item"
                        label="Ad group's daily spend cap"
                        helpMessage="Amount of budget autopilot can operate with on this ad group every day."
                        [value]="state.entity.autopilot.dailyBudget"
                        [currencySymbol]="currencySymbol"
                        fractionSize="0"
                        [isDisabled]="!store.isAdGroupAutopilotEnabled()"
                        [errors]="state.fieldsErrors.autopilot.dailyBudget"
                        (valueChange)="store.setAutopilotDailyBudget($event)"
                    ></zem-currency-setting>
                    <div
                        class="zem-settings-section__item zem-settings-section__item--indented"
                        *ngIf="!store.isAdGroupAutopilotEnabled()"
                    >
                        <div
                            class="zem-message zem-message--bubble zem-message--warning zem-message--with-icon zem-warning-bg-icon"
                        >
                            <ng-container
                                *ngIf="state.extras.isCampaignAutopilotEnabled"
                            >
                                Ad group's daily spend cap setting is disabled
                                because autopilot is managed on campaign level.
                            </ng-container>
                            <ng-container
                                *ngIf="!state.extras.isCampaignAutopilotEnabled"
                            >
                                Ad group's daily spend cap setting is disabled
                                because autopilot is not enabled on this ad
                                group.
                            </ng-container>
                        </div>
                    </div>
                </div>
                <zem-advanced-settings-section
                    class="zem-advanced-settings-section"
                    *ngIf="
                        zemPermissions.hasPermission(
                            'zemauth.can_set_click_capping'
                        ) ||
                        zemPermissions.hasPermission(
                            'zemauth.can_set_frequency_capping'
                        )
                    "
                >
                    <div class="zem-settings-section">
                        <zem-integer-setting
                            class="zem-integer-setting zem-settings-section__item"
                            *ngIf="
                                zemPermissions.hasPermission(
                                    'zemauth.can_set_click_capping'
                                )
                            "
                            [zemInternalFeature]="
                                zemPermissions.isPermissionInternal(
                                    'zemauth.can_set_click_capping'
                                )
                            "
                            label="Daily click cap"
                            helpMessage="Limit number of clicks you want to reach daily within the ad group. Zemanta will stop spending for the rest of the day once it hits the maximum number of clicks you set."
                            [value]="
                                store.state.entity
                                    .clickCappingDailyAdGroupMaxClicks
                            "
                            [errors]="
                                state.fieldsErrors
                                    .clickCappingDailyAdGroupMaxClicks
                            "
                            placeholder="No limit"
                            (valueChange)="store.setDailyClickCap($event)"
                        ></zem-integer-setting>
                        <div
                            class="zem-settings-section__item zem-settings-section__item--indented"
                        >
                            <div
                                class="zem-message zem-message--bubble zem-message--info zem-message--with-icon zem-info-bg-icon"
                            >
                                Outbrain and Yahoo donâ€™t support click capping
                                and will be automatically paused in this ad
                                group if you enable this setting.
                            </div>
                        </div>
                        <zem-integer-setting
                            class="zem-integer-setting zem-settings-section__item"
                            *ngIf="
                                zemPermissions.hasPermission(
                                    'zemauth.can_set_frequency_capping'
                                )
                            "
                            [zemInternalFeature]="
                                zemPermissions.isPermissionInternal(
                                    'zemauth.can_set_frequency_capping'
                                )
                            "
                            label="Daily impression frequency cap"
                            helpMessage="This setting defines the maximum number of times your ads from this ad group will be shown to a unique user in one day."
                            [value]="store.state.entity.frequencyCapping"
                            [errors]="state.fieldsErrors.frequencyCapping"
                            placeholder="No limit"
                            (valueChange)="
                                store.setImpressionFrequencyCap($event)
                            "
                        ></zem-integer-setting>
                        <div
                            class="zem-settings-section__item zem-settings-section__item--indented"
                        >
                            <div
                                class="zem-message zem-message--bubble zem-message--info zem-message--with-icon zem-info-bg-icon"
                            >
                                Outbrain and Yahoo donâ€™t support impression
                                frequency capping. Ads will run with no
                                limitations on these sources.
                            </div>
                        </div>
                    </div>
                </zem-advanced-settings-section>
            </div>

            <div class="zem-panel zem-settings__panel">
                <div class="zem-panel__header zem-settings__panel-header">
                    <h2 class="zem-settings__panel-header-title">
                        Device targeting
                    </h2>
                    <div
                        *ngIf="
                            zemPermissions.hasPermission(
                                'zemauth.settings_defaults_on_campaign_level'
                            ) && store.isDeviceTargetingDifferentFromDefault()
                        "
                        class="zem-settings__panel-header-message"
                    >
                        Different than campaign default
                    </div>
                </div>
                <div class="zem-settings-section">
                    <div class="zem-settings-section__header">
                        <div class="zem-settings-section__description">
                            The devices on which your content ads will be shown.
                        </div>
                    </div>
                    <zem-device-targeting-settings
                        class="zem-device-targeting-settings"
                        [targetDevices]="state.entity.targeting.devices"
                        [targetPlacements]="state.entity.targeting.placements"
                        [targetOs]="state.entity.targeting.os"
                        (onUpdate)="store.setDeviceTargeting($event.$event)"
                    ></zem-device-targeting-settings>
                </div>
            </div>
        </div>
        <div class="zem-drawer__footer zem-settings__settings-footer">
            <button (click)="saveSettings()">
                <ng-container *ngIf="isNewEntity">Create</ng-container>
                <ng-container *ngIf="!isNewEntity">Save</ng-container>
            </button>
            <button (click)="cancel()">Cancel</button>
            <button *ngIf="!isNewEntity" (click)="archive()">Archive</button>
        </div>
    </ng-container>
</zem-drawer>
