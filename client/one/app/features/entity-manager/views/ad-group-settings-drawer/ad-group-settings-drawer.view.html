<zem-drawer
    class="zem-drawer zem-ad-group-settings-drawer"
    [isOpen]="isOpen"
    [isClosable]="!isNewEntity"
    (closeRequest)="cancel()"
>
    <ng-container *ngIf="(store.state$ | async) as state">
        <div class="zem-drawer__header zem-settings__settings-header">
            {{ state.entity.name }}
        </div>
        <div
            class="zem-drawer__content custom-scroller zem-settings__settings-container"
        >
            <div class="zem-panel zem-settings__panel">
                <div class="zem-panel__header">
                    <h2 class="zem-settings__panel-header-title">General</h2>
                </div>
                <div class="zem-settings-section">
                    <zem-text-setting
                        class="zem-text-setting zem-settings-section__item"
                        label="Name"
                        [value]="state.entity.name"
                        [errors]="state.fieldsErrors.name"
                        (valueChange)="store.setName($event)"
                    ></zem-text-setting>
                    <zem-checkbox-setting
                        class="zem-checkbox-setting zem-settings-section__item"
                        *ngIf="
                            zemPermissions.hasPermission(
                                'zemauth.can_use_language_targeting'
                            )
                        "
                        label="Language matching"
                        helpMessage="Zemanta will show ads only when language of the page matches the language of your ads."
                        [value]="
                            state.entity.targeting.language.matchingEnabled
                        "
                        (valueChange)="store.setLanguageMatching($event)"
                    >
                        Enable language matching
                    </zem-checkbox-setting>
                </div>
            </div>

            <div class="zem-panel zem-settings__panel">
                <div class="zem-panel__header">
                    <h2 class="zem-settings__panel-header-title">Scheduling</h2>
                </div>
                <div class="zem-settings-section">
                    <zem-date-setting
                        class="zem-date-setting zem-settings-section__item"
                        label="Start date"
                        helpMessage="The start date of the ad group. If the date is set in the future, the ad group will not run until that date."
                        [value]="state.entity.startDate"
                        [isDisabled]="state.extras.isCampaignAutopilotEnabled"
                        [errors]="state.fieldsErrors.startDate"
                        (valueChange)="store.setStartDate($event)"
                    ></zem-date-setting>
                    <zem-date-setting
                        class="zem-date-setting zem-settings-section__item"
                        label="End date"
                        helpMessage="The end date of the ad group. Ad group will run until the end of stop date."
                        [value]="state.entity.endDate"
                        [isDisabled]="state.extras.isCampaignAutopilotEnabled"
                        [minDate]="minEndDate"
                        [allowManualOverride]="true"
                        [errors]="state.fieldsErrors.endDate"
                        (valueChange)="store.setEndDate($event)"
                    ></zem-date-setting>
                    <div
                        class="zem-settings-section__item zem-settings-section__item--indented"
                        *ngIf="state.extras.isCampaignAutopilotEnabled"
                    >
                        <div
                            class="zem-message zem-message--bubble zem-message--warning zem-message--with-icon zem-warning-bg-icon"
                        >
                            Flight time settings aren't available because
                            campaign budget optimization is enabled. Budget
                            flight time is used for running the ad group.
                        </div>
                    </div>
                    <zem-delivery-type-setting
                        class="zem-delivery-type-setting zem-settings-section__item"
                        *ngIf="
                            zemPermissions.hasPermission(
                                'zemauth.can_set_delivery_type'
                            )
                        "
                        [zemInternalFeature]="
                            zemPermissions.isPermissionInternal(
                                'zemauth.can_set_delivery_type'
                            )
                        "
                        [deliveryType]="state.entity.deliveryType"
                        [errors]="state.fieldsErrors.deliveryType"
                        (valueChange)="store.setDeliveryType($event)"
                    ></zem-delivery-type-setting>
                </div>
                <zem-advanced-settings-section
                    class="zem-advanced-settings-section"
                    *ngIf="
                        zemPermissions.hasPermission(
                            'zemauth.can_manage_ad_group_dayparting'
                        )
                    "
                >
                    <div class="zem-settings-section">
                        <div class="zem-settings-section__header">
                            <div
                                class="zem-settings-section__title"
                                [zemInternalFeature]="
                                    zemPermissions.isPermissionInternal(
                                        'zemauth.can_manage_ad_group_dayparting'
                                    )
                                "
                            >
                                Dayparting
                            </div>
                            <div class="zem-settings-section__description">
                                You can schedule your ads to be active for
                                specific hours and days of the week. Ads will be
                                shown in the viewer’s local time.
                            </div>
                        </div>
                        <zem-dayparting-setting
                            class="zem-dayparting-setting"
                            [daypartingSetting]="state.entity.dayparting"
                            [errors]="state.fieldsErrors.dayparting"
                            (valueChange)="store.setDayparting($event)"
                        ></zem-dayparting-setting>
                    </div>
                </zem-advanced-settings-section>
            </div>

            <div class="zem-panel zem-settings__panel">
                <div class="zem-panel__header">
                    <h2 class="zem-settings__panel-header-title">
                        Budgeting and daily limits
                    </h2>
                </div>
                <div class="zem-settings-section">
                    <zem-bidding-type-setting
                        class="zem-bidding-type-setting zem-settings-section__item"
                        *ngIf="
                            zemPermissions.hasPermission(
                                'zemauth.fea_can_use_cpm_buying'
                            )
                        "
                        [zemInternalFeature]="
                            zemPermissions.isPermissionInternal(
                                'zemauth.fea_can_use_cpm_buying'
                            )
                        "
                        [biddingType]="state.entity.biddingType"
                        [maxCpc]="state.entity.maxCpc"
                        [maxCpm]="state.entity.maxCpm"
                        [currencySymbol]="currencySymbol"
                        [biddingTypeErrors]="state.fieldsErrors.biddingType"
                        [maxCpcErrors]="state.fieldsErrors.maxCpc"
                        [maxCpmErrors]="state.fieldsErrors.maxCpm"
                        (biddingTypeChange)="store.setBiddingType($event)"
                        (maxCpcChange)="store.setMaxCpc($event)"
                        (maxCpmChange)="store.setMaxCpm($event)"
                    ></zem-bidding-type-setting>
                    <zem-currency-setting
                        class="zem-currency-setting zem-settings-section__item"
                        label="Ad group's daily spend cap"
                        helpMessage="Amount of budget autopilot can operate with on this ad group every day."
                        [value]="state.entity.autopilot.dailyBudget"
                        [currencySymbol]="currencySymbol"
                        fractionSize="0"
                        [isDisabled]="!store.isAdGroupAutopilotEnabled()"
                        [errors]="state.fieldsErrors.autopilot.dailyBudget"
                        (valueChange)="store.setAutopilotDailyBudget($event)"
                    ></zem-currency-setting>
                    <div
                        class="zem-settings-section__item zem-settings-section__item--indented"
                        *ngIf="!store.isAdGroupAutopilotEnabled()"
                    >
                        <div
                            class="zem-message zem-message--bubble zem-message--warning zem-message--with-icon zem-warning-bg-icon"
                        >
                            <ng-container
                                *ngIf="state.extras.isCampaignAutopilotEnabled"
                            >
                                Ad group's daily spend cap setting isn't
                                available because campaign budget optimization
                                is enabled.
                            </ng-container>
                            <ng-container
                                *ngIf="!state.extras.isCampaignAutopilotEnabled"
                            >
                                Ad group's daily spend cap setting isn't
                                available because optimization towards your
                                campaign goal is disabled.
                            </ng-container>
                        </div>
                    </div>
                </div>
                <zem-advanced-settings-section
                    class="zem-advanced-settings-section"
                    *ngIf="
                        zemPermissions.hasPermission(
                            'zemauth.can_set_click_capping'
                        ) ||
                        zemPermissions.hasPermission(
                            'zemauth.can_set_frequency_capping'
                        )
                    "
                >
                    <div class="zem-settings-section">
                        <zem-integer-setting
                            class="zem-integer-setting zem-settings-section__item"
                            *ngIf="
                                zemPermissions.hasPermission(
                                    'zemauth.can_set_click_capping'
                                )
                            "
                            [zemInternalFeature]="
                                zemPermissions.isPermissionInternal(
                                    'zemauth.can_set_click_capping'
                                )
                            "
                            label="Daily click cap"
                            helpMessage="Limit number of clicks you want to reach daily within the ad group. Zemanta will stop spending for the rest of the day once it hits the maximum number of clicks you set."
                            [value]="
                                store.state.entity
                                    .clickCappingDailyAdGroupMaxClicks
                            "
                            [errors]="
                                state.fieldsErrors
                                    .clickCappingDailyAdGroupMaxClicks
                            "
                            placeholder="No limit"
                            (valueChange)="store.setDailyClickCap($event)"
                        ></zem-integer-setting>
                        <div
                            class="zem-settings-section__item zem-settings-section__item--indented"
                        >
                            <div
                                class="zem-message zem-message--bubble zem-message--info zem-message--with-icon zem-info-bg-icon"
                            >
                                Outbrain and Yahoo don’t support click capping
                                and will be automatically paused in this ad
                                group if you enable this setting.
                            </div>
                        </div>
                        <zem-integer-setting
                            class="zem-integer-setting zem-settings-section__item"
                            *ngIf="
                                zemPermissions.hasPermission(
                                    'zemauth.can_set_frequency_capping'
                                )
                            "
                            [zemInternalFeature]="
                                zemPermissions.isPermissionInternal(
                                    'zemauth.can_set_frequency_capping'
                                )
                            "
                            label="Daily impression frequency cap"
                            helpMessage="This setting defines the maximum number of times your ads from this ad group will be shown to a unique user in one day."
                            [value]="store.state.entity.frequencyCapping"
                            [errors]="state.fieldsErrors.frequencyCapping"
                            placeholder="No limit"
                            (valueChange)="
                                store.setImpressionFrequencyCap($event)
                            "
                        ></zem-integer-setting>
                        <div
                            class="zem-settings-section__item zem-settings-section__item--indented"
                        >
                            <div
                                class="zem-message zem-message--bubble zem-message--info zem-message--with-icon zem-info-bg-icon"
                            >
                                Outbrain and Yahoo don’t support impression
                                frequency capping. Ads will run with no
                                limitations on these sources.
                            </div>
                        </div>
                    </div>
                </zem-advanced-settings-section>
            </div>

            <div class="zem-panel zem-settings__panel">
                <div class="zem-panel__header zem-settings__panel-header">
                    <h2 class="zem-settings__panel-header-title">
                        Device targeting
                    </h2>
                    <div
                        *ngIf="
                            zemPermissions.hasPermission(
                                'zemauth.settings_defaults_on_campaign_level'
                            ) && store.isDeviceTargetingDifferentFromDefault()
                        "
                        class="zem-settings__panel-header-message"
                    >
                        Different than campaign default
                    </div>
                </div>
                <div class="zem-settings-section">
                    <div class="zem-settings-section__header">
                        <div class="zem-settings-section__description">
                            The devices on which your content ads will be shown.
                        </div>
                    </div>
                    <zem-device-targeting-settings
                        class="zem-device-targeting-settings"
                        [targetDevices]="state.entity.targeting.devices"
                        [targetPlacements]="state.entity.targeting.placements"
                        [targetOs]="state.entity.targeting.os"
                        (onUpdate)="store.setDeviceTargeting($event.$event)"
                    ></zem-device-targeting-settings>
                </div>
            </div>

            <div class="zem-panel zem-settings__panel">
                <div class="zem-panel__header zem-settings__panel-header">
                    <h2 class="zem-settings__panel-header-title">
                        Location targeting
                    </h2>
                    <div
                        *ngIf="
                            zemPermissions.hasPermission(
                                'zemauth.settings_defaults_on_campaign_level'
                            ) && store.isLocationTargetingDifferentFromDefault()
                        "
                        class="zem-settings__panel-header-message"
                    >
                        Different than campaign default
                    </div>
                </div>
                <div class="zem-settings-section">
                    <div class="zem-settings-section__header">
                        <div class="zem-settings-section__description">
                            The countries, states and DMA regions where your
                            content ads will be shown.
                        </div>
                    </div>
                    <zem-geo-targeting
                        class="zem-geo-targeting"
                        [includedLocations]="
                            state.entity.targeting.geo.included
                        "
                        [excludedLocations]="
                            state.entity.targeting.geo.excluded
                        "
                        (onUpdate)="store.setLocationTargeting($event.$event)"
                    ></zem-geo-targeting>
                </div>
                <zem-advanced-settings-section
                    class="zem-advanced-settings-section"
                >
                    <div class="zem-settings-section">
                        <zem-zip-targeting
                            class="zem-zip-targeting"
                            [includedLocations]="
                                state.entity.targeting.geo.included
                            "
                            [excludedLocations]="
                                state.entity.targeting.geo.excluded
                            "
                            (onUpdate)="
                                store.setLocationTargeting($event.$event)
                            "
                        ></zem-zip-targeting>
                    </div>
                </zem-advanced-settings-section>
            </div>

            <div
                class="zem-panel zem-settings__panel"
                *ngIf="
                    !zemPermissions.hasPermission('zemauth.disable_public_rcs')
                "
            >
                <div class="zem-panel__header">
                    <h2 class="zem-settings__panel-header-title">Tracking</h2>
                </div>
                <div class="zem-settings-section">
                    <zem-tracking-code-setting
                        class="zem-tracking-code-setting"
                        [value]="state.entity.trackingCode"
                        [errors]="state.fieldsErrors.trackingCode"
                        (valueChange)="store.setTrackingCode($event)"
                    ></zem-tracking-code-setting>
                </div>
                <zem-advanced-settings-section
                    class="zem-advanced-settings-section"
                >
                    <div class="zem-settings-section">
                        <zem-tracking-pixel-setting
                            class="zem-tracking-pixel-setting"
                            [redirectPixelUrls]="state.entity.redirectPixelUrls"
                            [redirectJavascript]="
                                state.entity.redirectJavascript
                            "
                        ></zem-tracking-pixel-setting>
                    </div>
                </zem-advanced-settings-section>
            </div>

            <div
                class="zem-panel zem-settings__panel"
                *ngIf="
                    !zemPermissions.hasPermission('zemauth.disable_public_rcs')
                "
            >
                <div class="zem-panel__header">
                    <h2 class="zem-settings__panel-header-title">
                        Optimization
                    </h2>
                </div>
                <div
                    class="zem-settings-section"
                    *ngIf="state.extras.isCampaignAutopilotEnabled"
                >
                    <div
                        class="zem-message zem-message--bubble zem-message--info zem-message--with-icon zem-info-bg-icon"
                    >
                        Optimizations are managed on campaign level.
                    </div>
                </div>
                <ng-container *ngIf="!state.extras.isCampaignAutopilotEnabled">
                    <div class="zem-settings-section">
                        <zem-ad-group-autopilot-state-setting
                            class="zem-ad-group-autopilot-state-setting zem-settings-section__item"
                            [autopilotState]="state.entity.autopilot.state"
                            [optimizationObjective]="
                                state.extras.optimizationObjective
                            "
                            (autopilotStateChange)="
                                store.setAdGroupAutopilotState($event)
                            "
                        ></zem-ad-group-autopilot-state-setting>
                    </div>
                    <zem-advanced-settings-section
                        class="zem-advanced-settings-section"
                    >
                        <div class="zem-settings-section">
                            <zem-ad-group-rtb-sources-management-setting
                                class="zem-ad-group-rtb-sources-management-setting zem-settings-section__item"
                                [manageRtbSourcesAsOne]="
                                    state.entity.manageRtbSourcesAsOne
                                "
                                [isDisabled]="store.isAdGroupAutopilotEnabled()"
                                (manageRtbSourcesAsOneChange)="
                                    store.setManageRtbSourcesAsOne($event)
                                "
                            ></zem-ad-group-rtb-sources-management-setting>
                            <div
                                class="zem-settings-section__item zem-settings-section__item--indented"
                                *ngIf="store.isAdGroupAutopilotEnabled()"
                            >
                                <div
                                    class="zem-message zem-message--bubble zem-message--warning zem-message--with-icon zem-warning-bg-icon"
                                >
                                    You can't manage RTB sources while
                                    optimization towards your campaign goal is
                                    enabled.
                                </div>
                            </div>
                        </div>
                    </zem-advanced-settings-section>
                </ng-container>
            </div>

            <div class="zem-panel zem-settings__panel">
                <div class="zem-panel__header">
                    <h2 class="zem-settings__panel-header-title">
                        Audience targeting
                    </h2>
                </div>
                <div
                    class="zem-settings-section"
                    *ngIf="
                        zemPermissions.hasPermission(
                            'zemauth.can_set_white_blacklist_publisher_groups'
                        ) &&
                        zemPermissions.hasPermission(
                            'zemauth.can_see_publisher_groups_ui'
                        )
                    "
                >
                    <div class="zem-settings-section__header">
                        <div
                            class="zem-settings-section__title"
                            [zemInternalFeature]="
                                zemPermissions.isPermissionInternal(
                                    'zemauth.can_see_publisher_groups_ui'
                                )
                            "
                        >
                            Publishers
                        </div>
                        <div class="zem-settings-section__description">
                            Define your publisher targeting by whitelisting or
                            blacklisting publisher groups.
                        </div>
                    </div>
                    <zem-publisher-group-targeting
                        class="zem-publisher-group-targeting"
                        [accountId]="state.extras.accountId"
                        [whitelistedPublisherGroups]="
                            state.entity.targeting.publisherGroups.included
                        "
                        [blacklistedPublisherGroups]="
                            state.entity.targeting.publisherGroups.excluded
                        "
                        (onUpdate)="
                            store.setPublisherGroupsTargeting($event.$event)
                        "
                    ></zem-publisher-group-targeting>
                </div>
                <div
                    class="zem-settings-section"
                    *ngIf="
                        zemPermissions.hasPermission(
                            'zemauth.can_set_interest_targeting'
                        ) &&
                        !zemPermissions.hasPermission(
                            'zemauth.disable_public_rcs'
                        )
                    "
                >
                    <div class="zem-settings-section__header">
                        <div class="zem-settings-section__title">
                            Interest targeting
                        </div>
                        <div class="zem-settings-section__description">
                            Interest targeting is based on publisher
                            classification and user's reading habits.
                        </div>
                    </div>
                    <zem-interest-targeting
                        class="zem-interest-targeting"
                        [includedInterests]="
                            state.entity.targeting.interest.included
                        "
                        [excludedInterests]="
                            state.entity.targeting.interest.excluded
                        "
                        (onUpdate)="store.setInterestTargeting($event.$event)"
                    ></zem-interest-targeting>
                </div>
                <div
                    class="zem-settings-section"
                    *ngIf="
                        zemPermissions.hasPermission(
                            'zemauth.can_target_custom_audiences'
                        ) &&
                        !zemPermissions.hasPermission(
                            'zemauth.disable_public_rcs'
                        )
                    "
                >
                    <div class="zem-settings-section__header">
                        <div
                            class="zem-settings-section__title"
                            [zemInternalFeature]="
                                zemPermissions.isPermissionInternal(
                                    'zemauth.can_target_custom_audiences'
                                )
                            "
                        >
                            Retargeting
                        </div>
                        <div class="zem-settings-section__description">
                            Target people you have seen previously. Retargeting
                            can be based on pixels you placed or on clicks to
                            other ad groups.
                        </div>
                    </div>
                    <zem-retargeting
                        class="zem-retargeting"
                        [entityId]="state.entity.id"
                        [retargetableAudiences]="state.extras.audiences"
                        [retargetableAdGroups]="
                            state.extras.retargetableAdGroups
                        "
                        [includedAudiences]="
                            state.entity.targeting.customAudiences.included
                        "
                        [excludedAudiences]="
                            state.entity.targeting.customAudiences.excluded
                        "
                        [includedAdGroups]="
                            state.entity.targeting.retargetingAdGroups.included
                        "
                        [excludedAdGroups]="
                            state.entity.targeting.retargetingAdGroups.excluded
                        "
                        [warnings]="state.extras.warnings.retargeting"
                        (onUpdate)="store.setRetargeting($event.$event)"
                    ></zem-retargeting>
                </div>
                <div
                    class="zem-settings-section"
                    *ngIf="
                        zemPermissions.hasPermission(
                            'zemauth.can_use_bluekai_targeting'
                        ) &&
                        !zemPermissions.hasPermission(
                            'zemauth.disable_public_rcs'
                        )
                    "
                >
                    <div class="zem-settings-section__header">
                        <div class="zem-settings-section__title">
                            BlueKai targeting
                        </div>
                        <div class="zem-settings-section__description">
                            Setup audience targeting based on BlueKai audience
                            segments. For setting up Bombora, Liveramp or Lotame
                            targeting please contact your Customer Success
                            Manager.
                        </div>
                    </div>
                    <zem-demographic-targeting
                        class="zem-demographic-targeting"
                        [bluekaiTargeting]="state.entity.targeting.audience"
                        [entityId]="state.entity.id"
                        (onUpdate)="store.setBluekaiTargeting($event.$event)"
                    ></zem-demographic-targeting>
                </div>
                <div class="zem-settings-section">
                    <div class="zem-settings-section__header">
                        <div class="zem-settings-section__title">
                            Special notes
                        </div>
                        <div class="zem-settings-section__description">
                            Any additional targeting set on the backend will be
                            described here. This is a read-only section. Please
                            contact your Zemanta Customer Success Manager if you
                            want to set up or change it.
                        </div>
                    </div>
                    <div class="zem-dashed-box" *ngIf="state.entity.notes">
                        {{ state.entity.notes }}
                    </div>
                    <div class="zem-message" *ngIf="!state.entity.notes">
                        No special notes.
                    </div>
                </div>
            </div>

            <div
                class="zem-panel zem-settings__panel"
                *ngIf="
                    zemPermissions.hasPermission(
                        'zemauth.can_see_backend_hacks'
                    )
                "
            >
                <div class="zem-panel__header">
                    <h2
                        class="zem-settings__panel-header-title"
                        [zemInternalFeature]="
                            zemPermissions.isPermissionInternal(
                                'zemauth.can_see_backend_hacks'
                            )
                        "
                    >
                        Backend hacks
                    </h2>
                </div>
                <div class="zem-settings-section">
                    <zem-hacks
                        class="zem-hacks"
                        [hacks]="state.extras.hacks"
                    ></zem-hacks>
                </div>
            </div>

            <div
                class="zem-panel zem-settings__panel"
                *ngIf="
                    zemPermissions.hasPermission('zemauth.can_see_deals_in_ui')
                "
            >
                <div class="zem-panel__header">
                    <h2
                        class="zem-settings__panel-header-title"
                        [zemInternalFeature]="
                            zemPermissions.isPermissionInternal(
                                'zemauth.can_see_deals_in_ui'
                            )
                        "
                    >
                        Deals
                    </h2>
                </div>
                <div class="zem-settings-section">
                    <zem-deals
                        class="zem-deals"
                        [deals]="state.extras.deals"
                    ></zem-deals>
                </div>
            </div>
        </div>
        <div class="zem-drawer__footer zem-settings__settings-footer">
            <button (click)="saveSettings()">
                <ng-container *ngIf="isNewEntity">Create</ng-container>
                <ng-container *ngIf="!isNewEntity">Save</ng-container>
            </button>
            <button (click)="cancel()">Cancel</button>
            <button *ngIf="!isNewEntity" (click)="archive()">Archive</button>
        </div>
    </ng-container>
</zem-drawer>
