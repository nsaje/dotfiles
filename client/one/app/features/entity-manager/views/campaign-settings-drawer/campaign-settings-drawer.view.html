<zem-drawer
    class="zem-drawer zem-campaign-settings-drawer"
    [isOpen]="isOpen"
    [isClosable]="!isNewEntity"
    (closeRequest)="cancel()"
>
    <ng-container *ngIf="(store.state$ | async) as state">
        <zem-settings-drawer-header
            class="zem-settings-drawer-header zem-drawer__header"
            [entityId]="entityId"
            [entityType]="EntityType.CAMPAIGN"
            [entityName]="state.entity.name"
            [showAdminLink]="
                zemPermissions.hasPermission('zemauth.can_see_open_in_admin')
            "
            [isAdminLinkAnInternalFeature]="
                zemPermissions.isPermissionInternal(
                    'zemauth.can_see_open_in_admin'
                )
            "
            [entityNameErrors]="state.fieldsErrors.name"
            (entityNameChange)="store.setName($event)"
        ></zem-settings-drawer-header>
        <div
            class="zem-drawer__content custom-scroller zem-settings__settings-container"
        >
            <div
                class="zem-panel zem-settings__panel"
                *ngIf="
                    zemPermissions.hasPermission(
                        'zemauth.can_see_campaign_goals'
                    )
                "
                [zemInternalFeature]="
                    zemPermissions.isPermissionInternal(
                        'zemauth.can_see_campaign_goals'
                    )
                "
            >
                <div class="zem-panel__header">
                    <h2 class="zem-settings__panel-header-title">
                        Campaign goals
                    </h2>
                </div>
                <div class="zem-settings-section">
                    <div class="zem-settings-section__header">
                        <div class="zem-settings-section__description">
                            Define your marketing objectives by adding campaign
                            goals.
                        </div>
                    </div>
                    <div
                        class="zem-message zem-message--bubble zem-message--error zem-message--with-icon zem-campaign-goals__item"
                        *ngIf="
                            state.entity.goals.length === 0 &&
                            state.fieldsErrors.goalsMissing.length > 0
                        "
                    >
                        <span
                            *ngFor="
                                let error of state.fieldsErrors.goalsMissing
                            "
                        >
                            {{ error }}
                        </span>
                    </div>
                    <div
                        class="zem-message zem-message--bubble zem-message--warning zem-message--with-icon zem-campaign-goals__item"
                        *ngIf="
                            state.entity.goals.length === 0 &&
                            state.fieldsErrors.goalsMissing.length === 0
                        "
                    >
                        Currently there are no defined campaign goals.
                    </div>
                    <zem-campaign-goals
                        class="zem-campaign-goals"
                        [campaignType]="campaignType"
                        [onlyCpc]="
                            zemPermissions.hasPermission(
                                'zemauth.disable_public_rcs'
                            ) ||
                            zemPermissions.hasPermission(
                                'zemauth.disable_public_newscorp'
                            )
                        "
                        [currency]="state.extras.currency"
                        [campaignGoals]="state.entity.goals"
                        [campaignGoalsErrors]="state.fieldsErrors.goals"
                        [conversionPixels]="state.conversionPixels"
                        [conversionPixelsErrors]="state.conversionPixelsErrors"
                        [conversionPixelsRequests]="
                            state.conversionPixelsRequests
                        "
                        (campaignGoalCreate)="store.createGoal()"
                        (campaignGoalPrimaryChange)="
                            store.setPrimaryGoal($event)
                        "
                        (campaignGoalChange)="store.changeGoal($event)"
                        (campaignGoalDelete)="store.deleteGoal($event)"
                        (conversionPixelCreate)="
                            store.createConversionPixel($event)
                        "
                        (conversionPixelCancel)="
                            store.cancelConversionPixelCreation($event)
                        "
                    ></zem-campaign-goals>
                </div>
            </div>

            <div
                class="zem-panel zem-settings__panel"
                *ngIf="
                    !zemPermissions.hasPermission('zemauth.disable_public_rcs')
                "
            >
                <div class="zem-panel__header">
                    <h2 class="zem-settings__panel-header-title">
                        Performance tracking
                    </h2>
                </div>
                <div class="zem-settings-section">
                    <div class="zem-settings-section__header">
                        <div class="zem-settings-section__description">
                            Connect your Google/Adobe Analytics account to
                            better track your campaign performance.
                        </div>
                    </div>
                    <zem-campaign-performance-tracking
                        class="zem-campaign-performance-tracking"
                        [campaignTracking]="state.entity.tracking"
                        [campaignTrackingErrors]="state.fieldsErrors.tracking"
                        (campaignTrackingChange)="
                            store.changeCampaignTracking($event)
                        "
                    >
                    </zem-campaign-performance-tracking>
                </div>
            </div>

            <div
                class="zem-panel zem-settings__panel"
                *ngIf="
                    zemPermissions.hasPermission('zemauth.can_see_new_budgets')
                "
                [zemInternalFeature]="
                    zemPermissions.isPermissionInternal(
                        'zemauth.can_see_new_budgets'
                    )
                "
            >
                <div class="zem-panel__header">
                    <h2 class="zem-settings__panel-header-title">Budget</h2>
                </div>
                <div
                    class="zem-settings-section zem-campaign-settings-drawer__budgets-overview-section"
                >
                    <div class="zem-settings-section__header">
                        <div class="zem-settings-section__description">
                            Once Zemanta's Customer Success team assigns a
                            credit line to your account you have the ability to
                            create budget items and associate them with
                            campaigns you're planning. Budget represents the
                            amount of money you're willing to pay to have ads
                            from your campaign shown over the period you set it
                            to run. You set a budget for each campaign you
                            create.
                        </div>
                    </div>
                    <zem-campaign-budgets-overview
                        class="zem-campaign-budgets-overview"
                        [overview]="state.extras.budgetsOverview"
                        [currency]="state.extras.currency"
                    ></zem-campaign-budgets-overview>
                </div>
                <div class="zem-settings-section">
                    <div class="zem-settings-section__header">
                        <div class="zem-settings-section__title">
                            Active budget items
                        </div>
                    </div>
                    <div
                        class="zem-campaign-settings-drawer__budgets-list-container custom-scroller"
                    >
                        <zem-campaign-budgets-list
                            class="zem-campaign-budgets-list"
                            [budgets]="state.entity.budgets"
                            [currency]="state.extras.currency"
                            [budgetsErrors]="state.fieldsErrors.budgets"
                            [showLicenseFee]="canAccessPlatformCosts()"
                            [showMargin]="canAccessAgencyCosts()"
                            [isEditingEnabled]="
                                !zemPermissions.hasPermission(
                                    'zemauth.disable_budget_management'
                                )
                            "
                            [accountCredits]="state.extras.accountCredits"
                            [editFormTemplate]="campaignBudgetEditFormTemplate"
                            (budgetDelete)="store.deleteBudget($event)"
                        >
                        </zem-campaign-budgets-list>
                    </div>
                    <ng-template
                        #campaignBudgetEditFormTemplate
                        let-budget="budget"
                        let-currency="currency"
                        let-budgetErrors="budgetErrors"
                        let-showLicenseFee="showLicenseFee"
                        let-accountCredits="accountCredits"
                    >
                        <zem-campaign-budget-edit-form
                            class="zem-campaign-budget-edit-form"
                            [budget]="budget"
                            [currency]="currency"
                            [budgetErrors]="budgetErrors"
                            [showLicenseFee]="showLicenseFee"
                            [accountCredits]="accountCredits"
                            (budgetChange)="store.updateBudget($event)"
                        ></zem-campaign-budget-edit-form>
                    </ng-template>
                    <div
                        class="zem-settings-section__item"
                        *ngIf="
                            !zemPermissions.hasPermission(
                                'zemauth.disable_budget_management'
                            )
                        "
                    >
                        <button
                            type="button"
                            class="zem-button zem-button--with-icon zem-button--add-icon zem-campaign-goals__button"
                            (click)="store.createBudget()"
                            [disabled]="!store.isAnyAccountCreditAvailable()"
                        >
                            Add new budget item
                        </button>
                    </div>
                </div>
                <zem-advanced-settings-section
                    class="zem-advanced-settings-section"
                    [customLabelCollapsed]="'Show depleted budget items'"
                    [customLabelExpanded]="'Hide depleted budget items'"
                >
                    <div class="zem-settings-section">
                        <div class="zem-settings-section__header">
                            <div class="zem-settings-section__title">
                                Depleted budget items
                            </div>
                        </div>
                        <div
                            class="zem-campaign-settings-drawer__budgets-list-container custom-scroller"
                        >
                            <zem-campaign-budgets-list
                                class="zem-campaign-budgets-list"
                                [budgets]="state.extras.budgetsDepleted"
                                [currency]="state.extras.currency"
                                [showLicenseFee]="canAccessPlatformCosts()"
                                [showMargin]="canAccessAgencyCosts()"
                            ></zem-campaign-budgets-list>
                        </div>
                    </div>
                </zem-advanced-settings-section>
            </div>
        </div>
        <zem-settings-drawer-footer
            class="zem-settings-drawer-footer zem-drawer__footer zem-settings__settings-footer"
            [isNewEntity]="isNewEntity"
            [entityType]="EntityType.CAMPAIGN"
            [userHasPermissionToArchive]="
                zemPermissions.hasPermission('zemauth.archive_restore_entity')
            "
            [isArchiveActionInternal]="
                zemPermissions.isPermissionInternal(
                    'zemauth.archive_restore_entity'
                )
            "
            [isArchiveActionDisabled]="!state.extras.canArchive"
            [isLoading]="
                state.requests.create.inProgress ||
                state.requests.edit.inProgress
            "
            [hasError]="
                state.requests.create.error || state.requests.edit.error
            "
            (save)="saveSettings()"
            (cancel)="cancel()"
            (archive)="archive()"
        ></zem-settings-drawer-footer>
    </ng-container>
</zem-drawer>
