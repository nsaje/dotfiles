<div class="modal-header">
    <h4 class="modal-title" ng-if="isNew">Add Budget</h4>
    <h4 class="modal-title" ng-if="!isNew">Edit Budget Item #{{ budgetItem.id }}</h4>
</div>
<div class="modal-body modal-page">
    <form id="form-campaign-budget-budgetItem" class="form-horizontal" ng-class="{ 'new': isNew, 'edit': !isNew }">
        <div class="form-group" ng-if="!isNew">
            <label class="col-xs-8">Created by {{ budgetItem.createdBy }} on {{ budgetItem.createdOn }} </label>
        </div>
        <div class="form-group" ng-if="isNew">
            <label class="col-xs-8">Created by {{ user.name }} on {{ today }}</label>
        </div>
        <div class="form-group">
            <label for="credit-input" class="col-xs-12 control-label" ng-if="isNew">
                Select Credit Line
            </label>
            <label for="credit-input" class="col-xs-12 control-label" ng-if="!isNew">
                Selected Credit Line
            </label>
        </div>
        <div class="form-group" ng-class="{'has-error': !!errors.credit}">
            <div class="col-xs-12">
                <table class="table">
                    <thead>
                        <tr>
                            <th ng-if="isNew"></th>
                            <th>Available credit</th>
                            <th>Total Credit</th>
                            <th>License Fee</th>
                            <th>Valid From</th>
                            <th>Valid To</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="credit in availableCredit">
                            <td ng-if="isNew" title="{{ credit.comment }}">
                                <input type="radio" ng-model="budgetItem.credit" ng-click="checkCreditValues()" ng-value="credit" />
                            </td>
                            <td>{{ credit.available | decimalCurrency:"$":2  }}</td>
                            <td>{{ credit.total | decimalCurrency:"$":2  }}</td>
                            <td>{{ credit.licenseFee }}%</td>
                            <td>{{ credit.startDate }}</td>
                            <td>{{ credit.endDate }}</td>
                            <td>
                                <zem-note-popover content="{{ credit.isAgency ? 'Agency credit; ' : '' }}{{ credit.comment }}" placement="top"></zem-note-popover>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="form-group" ng-class="{'has-error': !!errors.startDate}">
            <label for="start-date-input" class="col-xs-3 control-label">
                Start Date
            </label>
            <div class="col-xs-4">
                <div class="form__prefixed-field form__prefixed-field--with-icon form__prefixed-field--calendar-icon">
                    <input id="start-date-input" type="text" class="form__input-text" uib-datepicker-popup="MM/dd/yyyy" ng-disabled="!budgetItem.credit || !budgetItem.isEditable" datepicker-options="{initDate: initStartDate, minDate: minDate, maxDate: maxDate}" ng-model="budgetItem.startDate" is-open="startDatePicker.isOpen" ng-click="openStartDatePicker()" />
                </div>
            </div>
            <label ng-repeat="error in errors.startDate" class="col-xs-5 control-label error" for="start-date-input">{{ error }}</label>
        </div>
        <div class="form-group" ng-class="{'has-error': !!errors.endDate}">
            <label for="end-date-input" class="col-xs-3 control-label">
                End Date
            </label>
            <div class="col-xs-4">
                <div class="form__prefixed-field form__prefixed-field--with-icon form__prefixed-field--calendar-icon">
                    <input id="end-date-input" type="text" class="form__input-text" uib-datepicker-popup="MM/dd/yyyy" ng-disabled="!budgetItem.credit || !(budgetItem.isUpdatable || budgetItem.isEditable)" datepicker-options="{initDate: initEndDate, minDate: minDate, maxDate: maxDate}" ng-model="budgetItem.endDate" is-open="endDatePicker.isOpen" ng-click="openEndDatePicker()">
                </div>
            </div>
            <label ng-repeat="error in errors.endDate" class="col-xs-5 control-label error" for="end-date-input">{{ error }}</label>
        </div>
        <div class="form-group" ng-class="{'has-error': !!errors.amount}">
            <label for="amount-input" class="col-xs-3 control-label">
                Total Budget
            </label>
            <div class="col-xs-4">
                <div class="form__prefixed-field form__postfixed-field">
                    <span class="form__field-prefix">$</span>
                    <input id="amount-input" ng-disabled="!budgetItem.credit || !(budgetItem.isEditable || budgetItem.isUpdatable)" type="text" class="form__input-text" ng-model="budgetItem.amount" zem-currency-input fraction-size="0" />
                    <span class="form__field-postfix">.00</span>
                </div>
            </div>
            <label ng-repeat="error in errors.amount" class="col-xs-5 control-label error" for="amount">{{ error }}</label>
        </div>
        <div class="form-group" ng-class="{'has-error': !!errors.margin}" ng-if="hasPermission('zemauth.can_manage_agency_margin')">
            <label for="margin-input" class="col-xs-3 control-label">
                <zem-internal-feature ng-if="isPermissionInternal('zemauth.can_manage_agency_margin')"></zem-internal-feature>
                Margin (%)
            </label>
            <div class="col-xs-4">
                <ui-select theme="select2" id="margin-select" class="button button--plain button--full-width button--dropdown-toggle-icon" ng-model="budgetItem.margin" ng-disabled="!isNew">
                    <ui-select-match>{{$select.selected | number:2}}%</ui-select-match>
                    <ui-select-choices repeat="fee in getLicenseFees($select.search, budgetItem.margin) | filter: $select.search">
                        <span ng-bind-html="fee"></span>%
                    </ui-select-choices>
                </ui-select>
            </div>
            <label ng-repeat="error in errors.margin" class="col-xs-5 control-label error" for="margin-input">{{ error }}</label>
        </div>
        <div class="row" ng-if="isInLanding()">
            <p class="col-xs-3"></p>
            <p class="col-xs-9 text-info">Add at least ${{ minAmount | number:2 }} to adjust media sources by your needs.</p>
        </div>
        <div class="form-group" ng-class="{'has-error': !!errors.comment}">
            <label for="comment-input" class="col-xs-3 control-label">
                Notes
            </label>
            <div class="col-xs-9">
                <textarea id="comment-input" type="text" class="form__textarea" ng-model="budgetItem.comment" maxlength="256"></textarea>
            </div>
            <label ng-repeat="error in errors.comment" class="col-xs-5 control-label error" for="comment">{{ error }}</label>
        </div>
    </form>
</div>
<div class="modal-footer buttons-panel">
    <button type="button" class="button button--highlight button--with-icon button--check-icon" ng-click="upsertBudgetItem()" ng-disabled="saveRequestInProgress">Save</button>
    <button type="button" class="button button--outline" ng-click="discardBudgetItem()" ng-disabled="saveRequestInProgress"><span class="text">Discard</span></button>
    <button type="button" class="button button--outline button--with-icon button--remove-icon pull-right" ng-click="deleteBudgetItem()" ng-disabled="isNew || saveRequestInProgress">Delete</button>

    <div class="loader" ng-show="saveRequestInProgress"></div>
    <span ng-show="saved" class="message message--success">Your updates have been saved.</span>
    <span ng-show="saved === false" class="message message--error">An error occurred while saving. Please correct the marked fields and save again.</span>
    <span ng-show="discarded" class="message">Your updates have been discarded.</span>
</div>
