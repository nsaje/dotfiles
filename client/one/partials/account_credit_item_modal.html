<div class="modal-header">
    <h4 class="modal-title" ng-if="isNew">Add Credit</h4>
    <h4 class="modal-title" ng-if="!isNew">Edit Credit Item #{{ creditItem.id }}</h4>
</div>
<div class="modal-body modal-page">
    <div class="loader" ng-show="isLoadingInProgress"></div>
    <form id="form-account-credit-item" class="form-horizontal" ng-class="{ 'new': isNew, 'edit': !isNew }" ng-show="!isLoadingInProgress">
        <div class="form-group" ng-if="!isNew">
            <label class="col-xs-8">Created by {{ creditItem.createdBy }} on {{ creditItem.createdOn }}</label>
        </div>
        <div class="form-group" ng-if="isNew">
            <label class="col-xs-8">Created by {{ user.name }} on {{ today }}</label>
        </div>
        <div class="form-group" ng-class="{'has-error': !!errors.startDate}">
            <label for="start-date-input" class="col-xs-3 control-label">
                Valid From
            </label>
            <div class="col-xs-4">
                <div class="input-group">
                    <div class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></div>
                    <input id="start-date-input" type="text" class="form-control" uib-datepicker-popup="MM/dd/yyyy" ng-model="creditItem.startDate" datepicker-options="startDatePickerOptions" is-open="startDatePicker.isOpen" ng-click="openStartDatePicker()" ng-disabled="creditItem.isSigned" />
                </div>
            </div>
            <label ng-repeat="error in errors.startDate" class="col-xs-5 control-label error" for="start-date-input">{{ error }}</label>
        </div>
        <div class="form-group" ng-class="{'has-error': !!errors.endDate}">
            <label for="end-date-input" class="col-xs-3 control-label">
                Valid To
            </label>
            <div class="col-xs-4">
                <div class="input-group">
                    <div class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></div>
                    <input id="end-date-input" type="text" class="form-control" uib-datepicker-popup="MM/dd/yyyy" ng-model="creditItem.endDate" datepicker-options="endDatePickerOptions" is-open="endDatePicker.isOpen" ng-click="openEndDatePicker()" />
                </div>
            </div>
            <label ng-repeat="error in errors.endDate" class="col-xs-5 control-label error" for="end-date-input">{{ error }}</label>
        </div>
        <div class="form-group" ng-class="{'has-error': !!errors.licenseFee}">
            <label for="license-fee-input" class="col-xs-3 control-label">
                License Fee (%)
            </label>
            <div class="col-xs-4">
                <ui-select theme="select2" id="license-fee-select" class="form-control" ng-model="creditItem.licenseFee" ng-disabled="creditItem.isSigned">
                    <ui-select-match>{{$select.selected | number:2}}%</ui-select-match>
                    <ui-select-choices repeat="fee in getLicenseFees($select.search, creditItem.licenseFee) | filter: $select.search">
                        <span ng-bind-html="fee"></span>%
                    </ui-select-choices>
                </ui-select>
            </div>

            <label ng-repeat="error in errors.licenseFee" class="col-xs-5 control-label error" for="license-fee">{{ error }}</label>
        </div>
        <div class="form-group" ng-class="{'has-error': !!errors.amount}">
            <label for="amount-input" class="col-xs-3 control-label">
                Credit
            </label>
            <div class="col-xs-4">
                <div class="input-group">
                    <span class="input-group-addon">$</span>
                    <input id="amount-input" type="text" class="form-control" ng-model="creditItem.amount" zem-currency-input fraction-size="0">
                    <div class="input-group-addon">.00</div>
                </div>
            </div>

            <label ng-repeat="error in errors.amount" class="col-xs-5 control-label error" for="amount">{{ error }}</label>
        </div>
        <div class="form-group" ng-class="{'has-error': !!errors.comment}">
            <label for="comment-input" class="col-xs-3 control-label">
                Custom Notes
            </label>
            <div class="col-xs-4">
                <textarea id="comment-input" type="text" class="form-control" ng-model="creditItem.comment" maxlength="256"></textarea>
            </div>
            <label ng-repeat="error in errors.comment" class="col-xs-5 control-label error" for="comment">{{ error }}</label>
        </div>
        <div class="form-group" ng-class="{'has-error': !!errors.agency}" ng-if="account.agency">
            <div class="col-xs-8">
                <label>
                    <input id="is-agency-input" type="checkbox" ng-model="creditItem.isAgency"> Agency credit
                </label>
            </div>
            <label ng-repeat="error in errors.agency" class="control-label error" for="is-agency-input">{{ error }}</label>
        </div>
        <hr />
        <div class="form-group">
            <label for="is-signed-input" class="col-xs-12 control-label">
                By signing the credit line item, no more future changes to the amount, fee and start date will be possible.
            </label>
        </div>
        <div class="form-group" ng-class="{'has-error': !!errors.status}">
            <div class="col-xs-12">
                <label>
                    <input type="checkbox" ng-model="creditItem.isSigned" ng-disabled="wasSigned"> Signed
                </label>
            </div>
            <label ng-repeat="error in errors.status" class="control-label error" for="is-signed-input">{{ error }}</label>
        </div>
        <hr ng-show="!isNew" />
        <div class="form-group" ng-show="!isNew">
            <label class="col-xs-8 control-label">
                Allocated budget items
            </label>
        </div>
        <div class="scrollable" ng-show="!isNew">
            <table class="table">
                <thead>
                    <tr>
                        <th>Campaign</th>
                        <th>Budget</th>
                        <th>Total spend</th>
                        <th>Flight dates</th>
						<th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="item in creditItem.budgets">
                        <td>{{ item.campaign }}</td>
                        <td>{{ item.total | decimalCurrency:"$":2  }}</td>
                        <td>{{ item.spend | decimalCurrency:"$":2  }}</td>
                        <td>{{ item.startDate }} - {{ item.endDate }}</td>
						<td><zem-note-popover content="{{ item.comment }}" placement="top"></zem-note-popover></td>
                    </tr>
                    <tr ng-show="!creditItem.numOfBudgets" class="message">
                        <td colspan="5">No allocated budget items.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </form>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-add btn-icon check" ng-click="upsertCreditItem()" ng-disabled="saveRequestInProgress"><span class="icon"></span><span class="text">Save</span></button>
    <button type="button" class="btn btn-blue btn-outline" ng-click="discardCreditItem()" ng-disabled="saveRequestInProgress"><span class="text">Discard</span></button>
    <button type="button" class="btn btn-blue btn-icon btn-outline remove pull-right" ng-click="deleteCreditItem()" ng-disabled="saveRequestInProgress"><span class="icon"></span><span class="text">Delete</span></button>
    <div class="loader" ng-show="saveRequestInProgress"></div>
    <span ng-show="saved" class="success">Your updates have been saved.</span>
    <span ng-show="saved === false" class="error">An error occurred while saving. Please correct the marked fields and save again.</span>
    <span ng-show="discarded" class="success">Your updates have been discarded.</span>
</div>