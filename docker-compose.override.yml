version: '2'

services:
    postgres:
        expose:
          - "5432"

    # this is fake telegraf that only prints stats on stdout
    telegraf:
        expose:
          - "8135/udp"

    memcached:
        expose:
          - "11211"
        command: memcached -I 5m

    einsstatic:
        hostname: einsstatic
        image: digitallyseamless/nodejs-bower-grunt:4
        ports:
          - "9999:9999"
        environment:
          - CLIENT_SKIP_RUN
        volumes:
          - "./client/:/data/:cached"
          - "/data/node_modules/"
        entrypoint: /bin/bash
        command: -c "npm prune && npm install && bower install --dev; [[ -z \"$$CLIENT_SKIP_RUN\" ]] && npm run dev || bash"
        tty: true

    eins:
        restart: always
        hostname: eins
        image: 569683728510.dkr.ecr.us-east-1.amazonaws.com/zemanta/z1
        ports:
          - "8000:8000"
        links:
          - "postgres:db"
          - "memcached:memcached"
          - "einsstatic"
          - "telegraf"
        volumes:
          - "./server/:/app/z1/"
          - ".:/src:ro"
          - "${HOME}/.aws:/home/ubuntu/.aws:ro"
        environment:
          - AWS_PROFILE
          - DB
        working_dir: /app/z1/
        entrypoint: /src/docker/entrypoint_dev.sh
        command: python manage.py runserver 0.0.0.0:8000
        tty: true
        stdin_open: true

networks:
    default:
        external:
            name: zemanta
