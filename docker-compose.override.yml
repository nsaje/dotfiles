version: '2'

services:
    postgres:
        expose:
          - "5432"

    # this is fake telegraf that only prints stats on stdout
    telegraf:
        expose:
          - "8135/udp"

    memcached:
        expose:
          - "11211"
        command: memcached -I 5m

    client:        
        image: $Z1_CLIENT_IMAGE
        ports:
          - "9999:9999"
        environment:
          - CLIENT_SKIP_RUN
        volumes:
          - "./client/:/app/:cached"
          - "/app/node_modules/"
        entrypoint: /bin/bash
        command: -c "npm prune && npm install && bower install --dev; [[ -z \"$$CLIENT_SKIP_RUN\" ]] && npm run dev || bash"
        tty: true

    server:
        restart: always        
        image: $Z1_SERVER_IMAGE
        ports:
          - "8000:8000"
        links:
          - "postgres:db"
          - "statspostgres:statsdb"
          - "memcached:memcached"
          - "client"
          - "telegraf"
        volumes:
          - "./server/:/app/z1/"
          - ".:/src:ro"
          - "${HOME}/.aws:/home/ubuntu/.aws:ro"
        environment:
          - AWS_PROFILE
          - DB
        working_dir: /app/z1/
        entrypoint: /src/docker/entrypoint_dev.sh
        command: python manage.py runserver 0.0.0.0:8000
        tty: true
        stdin_open: true

networks:
    default:
        external:
            name: zemanta
